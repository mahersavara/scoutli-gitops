apiVersion: batch/v1
kind: Job
metadata:
  name: db-init-job
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: db-init
        image: postgres:16-alpine
        command: ["/bin/sh", "-c"]
        args:
          - |
            export PGPASSWORD=$DB_PASSWORD;
            echo "Checking connection to $DB_HOST...";
            
            # Hàm tạo DB
            create_db() {
              DB_NAME=$1
              echo "Creating database $DB_NAME..."
              psql -h $DB_HOST -U $DB_USER -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = '$DB_NAME'" | grep -q 1 || psql -h $DB_HOST -U $DB_USER -d postgres -c "CREATE DATABASE $DB_NAME"
            }

            create_db "scoutli_auth"
            create_db "scoutli_discovery"
            create_db "scoutli_interaction"
            
            echo "All databases created successfully!";
        envFrom:
          - secretRef:
              name: scoutli-db-credentials
      restartPolicy: Never
  backoffLimit: 4
